<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infonex Audit Tool - Edición Profesional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Carga correcta de docx -->
    <script type="module">
        import { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, ImageRun, UnderlineType } from 'https://cdn.jsdelivr.net/npm/docx@9.5.1/+esm';
        window.docx = { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, ImageRun, UnderlineType };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .active-tab { background-color: #000000; color: white; border-radius: 0.75rem; }
        .input-field { background-color: #ffffff; border: 2px solid #000000; border-radius: 0.75rem; padding: 0.75rem 1rem; width: 100%; font-weight: 600; color: #000000; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: #ef4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.1); }
        .nav-item { transition: all 0.2s; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; font-size: 0.875rem; font-weight: 700; color: #000000; }
        .nav-item:hover { background-color: #f1f5f9; border-radius: 0.75rem; }
        label { color: #000000 !important; font-weight: 800 !important; }
        .card-dynamic { border-left: 8px solid #ef4444; background: #ffffff; padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; border: 2px solid #000000; border-left-width: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        
        .btn-photo-upload {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            background-color: #ef4444;
            color: #ffffff;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 800;
            font-size: 0.75rem;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #b91c1c;
            width: auto;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-photo-upload:hover { background-color: #dc2626; transform: translateY(-1px); }
        .btn-photo-upload:active { transform: scale(0.95); }

        /* Pie de página fijo */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border-top: 2px solid #000000;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #000000;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 relative pb-16"> <!-- pb-16 para evitar solapamiento con footer -->

<div id="app" class="min-h-screen flex flex-col md:flex-row">
    <!-- Sidebar -->
    <aside class="w-full md:w-80 bg-white border-r border-slate-300 flex flex-col shrink-0">
        <div class="p-6 border-b border-slate-200 flex items-center gap-3">
            <img src="https://res.cloudinary.com/dway4iqeh/image/upload/v1767447582/ISO_xenvys.png" alt="Infonex Logo" class="w-10 h-10 rounded-lg object-contain bg-gray-100">
            <div>
                <h1 class="font-extrabold text-black text-lg leading-none uppercase tracking-tight">Infonex</h1>
                <p class="text-[10px] text-red-600 font-black tracking-widest uppercase mt-1">Gestor de Informe de Seguridad</p>
            </div>
        </div>

        <nav id="sidebar-nav" class="flex-1 p-4 space-y-1"></nav>

        <div class="p-4 border-t border-slate-200">
            <button onclick="generateDoc()" id="btn-download" class="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-black text-sm flex items-center justify-center gap-3 transition-all active:scale-95 shadow-xl shadow-red-200">
                <i data-lucide="file-check" class="w-5 h-5"></i>
                <span>DESCARGAR INFORME DOCX</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 md:p-10 overflow-y-auto">
        <div class="max-w-4xl mx-auto">
            <div class="mb-8 flex justify-between items-end">
                <div>
                    <span id="tab-category" class="text-red-600 font-black text-xs tracking-widest uppercase bg-red-100 px-3 py-1 rounded-full border border-red-200">MODO EDICIÓN PROFESIONAL</span>
                    <h2 id="current-tab-title" class="text-4xl font-black text-black mt-2">Datos de Instalación</h2>
                </div>
                <div id="tab-counter" class="text-6xl font-black text-slate-300 tabular-nums">01</div>
            </div>

            <div class="bg-white rounded-[2rem] p-8 shadow-2xl border border-slate-200 min-h-[600px] flex flex-col">
                <div id="form-container" class="flex-1"></div>

                <div class="mt-8 flex justify-between pt-8 border-t border-slate-200">
                    <button id="btn-prev" onclick="changeTab(-1)" class="flex items-center gap-2 text-black font-black text-sm uppercase hover:translate-x-[-4px] transition-all">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Anterior
                    </button>
                    <button id="btn-next" onclick="changeTab(1)" class="bg-black hover:bg-slate-800 text-white px-10 py-4 rounded-2xl font-black text-sm uppercase flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-slate-300">
                        Siguiente <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- Pie de página fijo -->
<footer class="footer">
    <img src="https://res.cloudinary.com/dway4iqeh/image/upload/v1767447582/ISO_xenvys.png" alt="Nexcore Logo" class="h-8">
    <span>Soluciones Tecnologicas para empresas reales © 2025 NEXCORE TECH</span>
</footer>

<script>
    let activeTabId = 'general';
    let formData = {
        general: { empresa: 'Infonex S.A.', instalacion: '', ciudad: '', fecha: new Date().toLocaleDateString('es-ES'), tecnico: '', elaborador: '' },
        objetivos: { 
            principal: 'Evaluar integralmente las condiciones de seguridad física en servicio operativos, con el propósito de identificar vulnerabilidades, amenazas y el nivel de riesgo, para diseñar medidas de mitigación efectivas que aseguren la protección del personal, los activos críticos y la continuidad operativa de las instalaciones.',
            especificos: 'Detectar áreas críticas y sensibles dentro de las instalaciones.\nAnalizar amenazas de origen externo, interno y ambiental.\nEvaluar la eficacia de la seguridad física y tecnológica existente.\nElaborar un matriz de análisis de riesgos.\nProponer medidas de mitigación específicas y realistas.'
        },
        analisis: [{ amenazas: '', impacto: 'Alto', probabilidad: 'Media' }],
        hallazgos: [{ titulo: '', descripcion: '', fotos: [] }],
        recomendaciones: [{ descripcion: '', fotos: [] }],
        conclusion: { texto: 'El análisis de seguridad física realizado identificó vulnerabilidades vinculadas principalmente a riesgos de intrusión y robo planificado. Si bien el sitio presenta avances, aún persiste exposición en puntos claves. La implementación de las medidas propuestas permitirá elevar el nivel de protección a estándar industrial seguro.' }
    };

    const SECTIONS = [
        { id: 'general', title: 'Datos Generales', icon: 'info' },
        { id: 'objetivos', title: 'Objetivos', icon: 'target' },
        { id: 'analisis', title: 'Análisis de Riesgo', icon: 'alert-triangle' },
        { id: 'hallazgos', title: 'Hallazgos Técnicos', icon: 'search' },
        { id: 'recomendaciones', title: 'Recomendaciones', icon: 'lightbulb' },
        { id: 'conclusion', title: 'Conclusión', icon: 'check-circle' }
    ];

    window.onload = () => { 
        renderSidebar(); 
        renderForm(); 
        updateUI();
        lucide.createIcons();
    };

    function renderSidebar() {
        const nav = document.getElementById('sidebar-nav');
        nav.innerHTML = SECTIONS.map(s => `
            <div onclick="setTab('${s.id}')" class="nav-item ${activeTabId === s.id ? 'active-tab shadow-lg' : ''}">
                <i data-lucide="${s.icon}" class="w-5 h-5 ${activeTabId === s.id ? 'text-red-400' : 'text-black'}"></i>
                ${s.title}
            </div>
        `).join('');
        lucide.createIcons();
    }

    function setTab(id) { 
        activeTabId = id; 
        renderSidebar(); 
        renderForm(); 
        updateUI();
    }
    
    function changeTab(dir) {
        const idx = SECTIONS.findIndex(s => s.id === activeTabId);
        const next = idx + dir;
        if (next >= 0 && next < SECTIONS.length) {
            setTab(SECTIONS[next].id);
        } else if (next === SECTIONS.length) {
            generateDoc();
        }
    }

    function updateUI() {
        const idx = SECTIONS.findIndex(s => s.id === activeTabId);
        document.getElementById('current-tab-title').innerText = SECTIONS[idx].title;
        document.getElementById('tab-counter').innerText = (idx + 1).toString().padStart(2, '0');
        document.getElementById('btn-prev').style.visibility = idx === 0 ? 'hidden' : 'visible';
        document.getElementById('btn-next').innerText = idx === SECTIONS.length - 1 ? 'GENERAR INFORME' : 'CONTINUAR';
    }

    function addItem(type) {
        if (type === 'analisis') formData.analisis.push({ amenazas: '', impacto: 'Alto', probabilidad: 'Media' });
        if (type === 'hallazgos') formData.hallazgos.push({ titulo: '', descripcion: '', fotos: [] });
        if (type === 'recomendaciones') formData.recomendaciones.push({ descripcion: '', fotos: [] });
        renderForm();
    }

    function removeItem(type, index) {
        formData[type].splice(index, 1);
        if (formData[type].length === 0) addItem(type);
        renderForm();
    }

    function updateItemField(type, index, field, value) { 
        formData[type][index][field] = value; 
    }

    function handlePhotoUpload(type, index, e) {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                formData[type][index].fotos.push(ev.target.result);
                renderForm();
            };
            reader.readAsDataURL(file);
        });
    }

    function removePhoto(type, itemIdx, photoIdx) {
        formData[type][itemIdx].fotos.splice(photoIdx, 1);
        renderForm();
    }

    // FUNCIÓN PROFESIONAL DE MEJORA DE TEXTOS (como experto en seguridad privada)
    function mejorarTextoSeguridad(textoOriginal, esTitulo = false, esRecomendacion = false) {
        if (!textoOriginal || textoOriginal.trim() === '') return '';

        let texto = textoOriginal.trim();
        texto = texto.charAt(0).toUpperCase() + texto.slice(1).toLowerCase();

        const terminosTecnicos = {
            'puerta': 'puerta de acceso',
            'ventana': 'ventana perimetral',
            'reja': 'reja de protección',
            'cerradura': 'sistema de cierre mecánico',
            'candado': 'candado de seguridad',
            'muro': 'cerramiento perimetral',
            'cerca': 'cerramiento perimetral',
            'portón': 'portón vehicular',
            'cámara': 'cámara de videovigilancia CCTV',
            'dvr': 'grabador digital DVR/NVR',
            'alarma': 'sistema de alarma contra intrusión',
            'sensor': 'sensor perimetral/volumétrico',
            'rota': 'presenta daños estructurales',
            'roto': 'presenta daños estructurales',
            'dañada': 'en estado de deterioro',
            'dañado': 'en estado de deterioro',
            'abierto': 'sin cierre efectivo',
            'sin llave': 'sin control de acceso adecuado',
            'sin mantenimiento': 'sin evidencia de mantenimiento preventivo',
            'falta': 'ausencia de',
            'no tiene': 'no cuenta con',
            'no hay': 'ausencia de',
            'oscuro': 'insuficiente iluminación de seguridad',
            'expuesto': 'expuesto a riesgo de intrusión',
            'se ve': 'se identifica',
            'se observa': 'se detecta',
            'esta mal': 'presenta deficiencia',
            'hay que': 'es necesario',
            'recomiendo': 'se recomienda',
            'arreglar': 'reparar y poner en funcionamiento',
            'cambiar': 'reemplazar por elemento de mayor resistencia',
            'poner': 'instalar'
        };

        for (const [informal, tecnico] of Object.entries(terminosTecnicos)) {
            const regex = new RegExp('\\b' + informal + '\\b', 'gi');
            texto = texto.replace(regex, tecnico);
        }

        if (esTitulo) {
            texto = texto.toUpperCase();
            if (!texto.endsWith('IDENTIFICADA')) texto = texto.replace(/\.$/, '') + ' - VULNERABILIDAD IDENTIFICADA';
        }

        if (!esRecomendacion && !esTitulo) {
            if (!texto.toLowerCase().includes('constituye una vulnerabilidad')) {
                texto += ' Lo anterior constituye una vulnerabilidad crítica de seguridad física que facilita potenciales accesos no autorizados y expone activos protegidos.';
            }
        }

        if (esRecomendacion) {
            if (!texto.toLowerCase().startsWith('se recomienda')) {
                texto = 'Se recomienda implementar de forma inmediata: ' + texto.toLowerCase();
            }
            if (!texto.includes('prioridad alta')) {
                texto += ', con prioridad alta, conforme a estándares de seguridad física y normativa vigente.';
            }
        }

        if (!texto.endsWith('.')) texto += '.';
        return texto;
    }

    function renderForm() {
        const container = document.getElementById('form-container');
        let html = '';

        if (activeTabId === 'general') {
            html = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3"><label class="text-xs uppercase">INSTALACIÓN</label><input type="text" value="${formData.general.instalacion}" oninput="formData.general.instalacion = this.value" class="input-field" placeholder="Nombre de la planta/sitio"></div>
                    <div class="space-y-3"><label class="text-xs uppercase">CIUDAD / COMUNA</label><input type="text" value="${formData.general.ciudad}" oninput="formData.general.ciudad = this.value" class="input-field"></div>
                    <div class="space-y-3"><label class="text-xs uppercase">TRABAJO DE CAMPO</label><input type="text" value="${formData.general.tecnico}" oninput="formData.general.tecnico = this.value" class="input-field"></div>
                    <div class="space-y-3"><label class="text-xs uppercase">ANÁLISIS Y ELABORACIÓN</label><input type="text" value="${formData.general.elaborador}" oninput="formData.general.elaborador = this.value" class="input-field"></div>
                    <div class="space-y-3"><label class="text-xs uppercase">FECHA</label><input type="text" value="${formData.general.fecha}" oninput="formData.general.fecha = this.value" class="input-field"></div>
                </div>
            `;
        } else if (activeTabId === 'objetivos') {
            html = `
                <div class="space-y-6">
                    <div class="space-y-2"><label class="text-xs uppercase">OBJETIVO GENERAL</label><textarea oninput="formData.objetivos.principal = this.value" class="input-field h-32 resize-none">${formData.objetivos.principal}</textarea></div>
                    <div class="space-y-2"><label class="text-xs uppercase">OBJETIVOS ESPECÍFICOS (UNO POR LÍNEA)</label><textarea oninput="formData.objetivos.especificos = this.value" class="input-field h-48 resize-none">${formData.objetivos.especificos}</textarea></div>
                </div>
            `;
        } else if (activeTabId === 'analisis') {
            html = formData.analisis.map((item, i) => `
                <div class="card-dynamic">
                    <div class="flex justify-between mb-4"><span class="font-black text-black uppercase">AMENAZA / RIESGO #${i+1}</span>${i > 0 ? `<button onclick="removeItem('analisis', ${i})" class="text-red-600 font-bold">ELIMINAR</button>` : ''}</div>
                    <div class="space-y-4">
                        <input type="text" value="${item.amenazas}" oninput="updateItemField('analisis', ${i}, 'amenazas', this.value)" class="input-field" placeholder="Ej: Intrusión por cierre perimetral dañado">
                        <div class="grid grid-cols-2 gap-4">
                            <select onchange="updateItemField('analisis', ${i}, 'impacto', this.value)" class="input-field">
                                <option value="Bajo" ${item.impacto === 'Bajo' ? 'selected' : ''}>Impacto Bajo</option>
                                <option value="Medio" ${item.impacto === 'Medio' ? 'selected' : ''}>Impacto Medio</option>
                                <option value="Alto" ${item.impacto === 'Alto' ? 'selected' : ''}>Impacto Alto</option>
                            </select>
                            <select onchange="updateItemField('analisis', ${i}, 'probabilidad', this.value)" class="input-field">
                                <option value="Baja" ${item.probabilidad === 'Baja' ? 'selected' : ''}>Probabilidad Baja</option>
                                <option value="Media" ${item.probabilidad === 'Media' ? 'selected' : ''}>Probabilidad Media</option>
                                <option value="Alta" ${item.probabilidad === 'Alta' ? 'selected' : ''}>Probabilidad Alta</option>
                            </select>
                        </div>
                    </div>
                </div>
            `).join('') + `<button onclick="addItem('analisis')" class="w-full border-2 border-black py-4 rounded-xl font-black uppercase hover:bg-slate-50">+ AGREGAR RIESGO</button>`;
        } else if (activeTabId === 'hallazgos' || activeTabId === 'recomendaciones') {
            const type = activeTabId;
            html = formData[type].map((item, i) => `
                <div class="card-dynamic">
                    <div class="flex justify-between mb-4"><span class="font-black text-black uppercase">${type === 'hallazgos' ? 'HALLAZGO' : 'RECOMENDACIÓN'} #${i+1}</span>${i > 0 ? `<button onclick="removeItem('${type}', ${i})" class="text-red-600 font-bold">X</button>` : ''}</div>
                    <div class="space-y-4">
                        ${type === 'hallazgos' ? `<input type="text" placeholder="Título del hallazgo" value="${item.titulo}" oninput="updateItemField('${type}', ${i}, 'titulo', this.value)" class="input-field">` : ''}
                        <textarea placeholder="Detalle técnico..." oninput="updateItemField('${type}', ${i}, 'descripcion', this.value)" class="input-field h-24 resize-none">${item.descripcion || ''}</textarea>
                        
                        <div class="space-y-2 mt-4">
                            <label class="text-[10px] uppercase font-black tracking-widest block text-red-600">Evidencia Fotográfica</label>
                            <label class="btn-photo-upload">
                                <i data-lucide="camera" class="w-4 h-4"></i>
                                <span>Subir fotos</span>
                                <input type="file" multiple accept="image/*" class="hidden" onchange="handlePhotoUpload('${type}', ${i}, event)">
                            </label>
                            
                            <div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-2 mt-2">
                                ${item.fotos.map((p, pi) => `
                                    <div class="relative aspect-square border-2 border-black rounded-lg overflow-hidden shadow-sm">
                                        <img src="${p}" class="w-full h-full object-cover">
                                        <button onclick="removePhoto('${type}', ${i}, ${pi})" class="absolute top-0.5 right-0.5 bg-red-600 text-white w-5 h-5 rounded-full flex items-center justify-center font-bold text-[10px]">X</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('') + `<button onclick="addItem('${type}')" class="w-full border-2 border-black py-4 rounded-xl font-black shadow-md hover:bg-slate-50 transition-all uppercase">+ AGREGAR ${activeTabId === 'hallazgos' ? 'HALLAZGO' : 'RECOMENDACIÓN'}</button>`;
        } else if (activeTabId === 'conclusion') {
            html = `<textarea oninput="formData.conclusion.texto = this.value" class="input-field h-[400px] resize-none text-lg">${formData.conclusion.texto}</textarea>`;
        }

        container.innerHTML = html;
        lucide.createIcons();
    }

    async function generateDoc() {
        const btn = document.getElementById('btn-download');
        const originalContent = btn.innerHTML;

        if (!window.docx) {
            alert("La librería docx aún se está cargando. Espera unos segundos y vuelve a intentarlo.");
            return;
        }

        const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType, ImageRun, UnderlineType } = window.docx;

        btn.innerHTML = '<span class="animate-pulse">PROCESANDO...</span>';
        btn.disabled = true;

        try {
            const children = [];

            children.push(new Paragraph({
                children: [new TextRun({ text: "MINUTA INFORME DE ESTADO SERVICIO", bold: true, size: 28, color: "FF0000" })],
                alignment: AlignmentType.LEFT,
                spacing: { after: 400 }
            }));

            children.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                    ["Nombre de la Empresa de Seguridad:", formData.general.empresa],
                    ["Nombre de la Instalación:", formData.general.instalacion || ''],
                    ["Ciudad / Comuna:", formData.general.ciudad || ''],
                    ["Fecha de Emisión:", formData.general.fecha || ''],
                    ["Trabajo de Campo:", formData.general.tecnico || ''],
                    ["Análisis y Elaboración de Informe:", formData.general.elaborador || '']
                ].map(pair => new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: pair[0], bold: true, size: 20 })] })] }),
                        new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: pair[1], size: 20 })] })] })
                    ]
                }))
            }));

            children.push(new Paragraph({ text: "______________________________________________________________________", spacing: { before: 200, after: 400 } }));

            children.push(new Paragraph({ children: [new TextRun({ text: "OBJETIVO DEL INFORME", bold: true, size: 24, underline: { type: UnderlineType.SINGLE } })], spacing: { after: 150 } }));
            children.push(new Paragraph({ text: formData.objetivos.principal, alignment: AlignmentType.BOTH, spacing: { after: 300 } }));

            children.push(new Paragraph({ children: [new TextRun({ text: "OBJETIVOS ESPECÍFICOS", bold: true, size: 24, underline: { type: UnderlineType.SINGLE } })], spacing: { after: 150 } }));
            formData.objetivos.especificos.split('\n').filter(l => l.trim()).forEach(line => {
                children.push(new Paragraph({ 
                    children: [new TextRun({ text: "• ", bold: true }), new TextRun(line.trim())],
                    spacing: { after: 100 },
                    alignment: AlignmentType.BOTH
                }));
            });

            children.push(new Paragraph({ children: [new TextRun({ text: "ANÁLISIS DE RIESGOS", bold: true, size: 24, underline: { type: UnderlineType.SINGLE } })], spacing: { before: 400, after: 200 } }));

            function getCriticidad(impacto, probabilidad) {
                const map = { 'Bajo': 1, 'Baja': 1, 'Medio': 2, 'Media': 2, 'Alto': 3, 'Alta': 3 };
                const risk = (map[impacto] || 1) * (map[probabilidad] || 1);
                if (risk >= 6) return 'Alta';
                if (risk >= 4) return 'Media';
                return 'Baja';
            }

            function getColor(criticidad) {
                if (criticidad === 'Alta') return 'FFCCCC';
                if (criticidad === 'Media') return 'FFFFCC';
                return 'CCFFCC';
            }

            children.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                    new TableRow({
                        children: ["Amenazas / Riesgos detectados", "Impacto", "Probabilidad", "Criticidad"].map(h => new TableCell({
                            children: [new Paragraph({ children: [new TextRun({ text: h, bold: true, size: 18 })], alignment: AlignmentType.CENTER })],
                            shading: { fill: "D9D9D9" }
                        }))
                    }),
                    ...formData.analisis.filter(a => a.amenazas.trim()).map(a => new TableRow({
                        children: [
                            new TableCell({ children: [new Paragraph({ text: a.amenazas, size: 18 })] }),
                            new TableCell({ children: [new Paragraph({ text: a.impacto, size: 18, alignment: AlignmentType.CENTER })] }),
                            new TableCell({ children: [new Paragraph({ text: a.probabilidad, size: 18, alignment: AlignmentType.CENTER })] }),
                            new TableCell({ 
                                children: [new Paragraph({ text: getCriticidad(a.impacto, a.probabilidad), size: 18, bold: true, alignment: AlignmentType.CENTER })], 
                                shading: { fill: getColor(getCriticidad(a.impacto, a.probabilidad)) } 
                            })
                        ]
                    }))
                ]
            }));

            // HALLAZGOS con mejora profesional
            children.push(new Paragraph({ children: [new TextRun({ text: "HALLAZGOS TÉCNICOS Y EVIDENCIAS", bold: true, size: 24, underline: { type: UnderlineType.SINGLE } })], spacing: { before: 500, after: 200 } }));
            formData.hallazgos.forEach(h => {
                if (h.titulo || h.descripcion || h.fotos.length > 0) {
                    const tituloMejorado = mejorarTextoSeguridad(h.titulo, true, false);
                    const descripcionMejorada = mejorarTextoSeguridad(h.descripcion, false, false);

                    if (tituloMejorado) children.push(new Paragraph({ children: [new TextRun({ text: tituloMejorado, bold: true, size: 20 })], spacing: { before: 300 } }));
                    if (descripcionMejorada) children.push(new Paragraph({ text: descripcionMejorada, alignment: AlignmentType.BOTH, spacing: { after: 200 } }));

                    h.fotos.forEach(f => {
                        try {
                            const base64 = f.split(',')[1];
                            const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                            children.push(new Paragraph({
                                alignment: AlignmentType.CENTER,
                                children: [new ImageRun({ data: bytes, transformation: { width: 450, height: 300 } })],
                                spacing: { after: 300 }
                            }));
                        } catch (e) { console.error("Error imagen hallazgo", e); }
                    });
                }
            });

            // RECOMENDACIONES con mejora profesional
            children.push(new Paragraph({ children: [new TextRun({ text: "RECOMENDACIONES", bold: true, size: 24, underline: { type: UnderlineType.SINGLE } })], spacing: { before: 400, after: 200 } }));
            formData.recomendaciones.forEach(r => {
                if (r.descripcion || r.fotos.length > 0) {
                    const descripcionMejorada = mejorarTextoSeguridad(r.descripcion, false, true);
                    if (descripcionMejorada) {
                        children.push(new Paragraph({ 
                            children: [new TextRun({ text: "• ", bold: true }), new TextRun(descripcionMejorada)], 
                            alignment: AlignmentType.BOTH, 
                            spacing: { after: 150 } 
                        }));
                    }

                    r.fotos.forEach(f => {
                        try {
                            const base64 = f.split(',')[1];
                            const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
                            children.push(new Paragraph({
                                alignment: AlignmentType.CENTER,
                                children: [new ImageRun({ data: bytes, transformation: { width: 400, height: 250 } })],
                                spacing: { after: 200 }
                            }));
                        } catch (e) { console.error("Error imagen recomendación", e); }
                    });
                }
            });

            children.push(new Paragraph({ children: [new TextRun({ text: "CONCLUSIÓN", bold: true, size: 24, underline: { type: UnderlineType.SINGLE } })], spacing: { before: 400, after: 200 } }));
            children.push(new Paragraph({ text: formData.conclusion.texto, alignment: AlignmentType.BOTH }));

            const doc = new Document({ sections: [{ properties: {}, children }] });
            const blob = await Packer.toBlob(doc);
            const filename = `Informe_Auditoria_${(formData.general.instalacion || 'Infonex').replace(/\s+/g, '_')}_${formData.general.fecha.replace(/\//g, '-')}.docx`;
            saveAs(blob, filename);

        } catch (err) {
            console.error("ERROR GENERACIÓN:", err);
            alert("Error al generar el documento. Revisa la consola (F12) para más detalles.");
        } finally {
            btn.innerHTML = originalContent;
            btn.disabled = false;
        }
    }
</script>
</body>
</html>